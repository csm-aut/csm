{% extends 'base_software.html' %}

{% from 'host/common.html' import edit_field %}
{% from 'host/common.html' import alert_duplicate %}

{% if request.endpoint.endswith('edit') %}
    {% set isEdit = True %}
{% else %}
    {% set isEdit = False %}
{% endif %}

{% block head %}

<script>

    $(function() {
        var spinner = $('#spinner');
        spinner.hide();

        $('#plugin-details').hide();

        var plugin_to_user_input = {};
        var plugin_uid = 0;
        var last_selected_plugin_uid = 0;

        var plugin_specs = {};

        var original_mop_name = "";

        if ($('#mop_name').val()) {
            original_mop_name = $('#mop_name').val();
        }

        $('#selected-plugins').on('click', "div a", function () {
            if ($(this).attr('class') == "need-data") {
                last_selected_plugin_uid = $(this).attr('name').split('_')[1];
                var plugin_data_html = generate_plugin_detail_template(last_selected_plugin_uid, $(this).html(), plugin_to_user_input);
                if (plugin_data_html) {
                    $('#plugin-data').html(plugin_data_html);
                    $('#plugin-details').modal({show: true, backdrop: 'static'});
                }
            }

        });

        $('body').on('click', '#save-plugin-data', function () {

            var keys = [];
            var values = [];
            $('#plugin-details label[id^="label_"]').each(function () {
                keys.push($(this).html().toLowerCase().replace(" ", "_"));
            });

            var last_id = null;
            $('#plugin-details [id^="field_"]').each(function () {
                if ($(this).attr("id") == last_id) {
                    if ($(this).is(':checked')) {
                        values[values.length - 1] = $(this).val();
                    }
                } else {
                    values.push($(this).val());
                }
                last_id = $(this).attr("id");
            });
            if (keys.length != values.length) {
                bootbox.alert("Error saving supplied data.");
                return false;
            }
            plugin_to_user_input[last_selected_plugin_uid] = {};
            var i;
            for (i = 0; i < keys.length; i++) {
                plugin_to_user_input[last_selected_plugin_uid][keys[i]] = values[i];
            }
            $('#plugin-details').modal('hide');

        });


        $("#phase").select2();
        $("#platform").select2();

        var all_phases = get_all_valid_options_from_selector("phase");
        var all_platforms = get_all_valid_options_from_selector("platform");

        function get_all_valid_options_from_selector(selector_id) {
            var options = $("#" + selector_id + " option");
            return $.map(options, function (option) {
                if (option.value != "ALL") {
                    return option.value;
                }
            });
        }

        set_selected_options_when_all_is_selected($('#phase'), all_phases);
        set_selected_options_when_all_is_selected($('#platform'), all_platforms);

        function set_selected_options_when_all_is_selected(selector, all_valid_options) {
            selector.on('change', function (e) {
                var selected = $(this).val();

                if (has_one_of_these(selected, ["ALL"])) {
                    selector.val(all_valid_options).trigger('change');
                }
                get_available_plugins(false)
            });
        }


        function get_available_plugins(first_load_on_edit) {
            $.ajax({
                url: "/mop/get_available_plugins_and_required_data",
                dataType: 'json',
                type: "POST",
                data: {
                    phases: $('#phase').val(),
                    platforms: $('#platform').val()
                },
                success: function (data) {
                    $("#available-plugins").empty();

                    var $available_plugins_container = $("#available-plugins");

                    plugin_specs = data.plugin_specs;

                    for (var plugin_name in plugin_specs) {
                        var html = "<div>";
                        var info_data_toggle = "description_" + plugin_name.split(" ").join("_");

                        if (Object.keys(plugin_specs[plugin_name]["data_specs"]).length > 0) {
                            html += "<a href='javascript://' data-toggle='" + info_data_toggle + "'name='" + get_next_plugin_uid() + "' class='need-data'>" + plugin_name + "</a>";
                        } else {
                            html += "<a href='javascript://' data-toggle='" + info_data_toggle + "'name='" + get_next_plugin_uid() + "' class='no-data'>" + plugin_name + "</a>";
                        }
                        //html += "&nbsp;&nbsp;&nbsp;&nbsp;<a href='javascript://'><span class='glyphicon glyphicon-info-sign' style='color:dodgerblue' aria-hidden='true' data-toggle='" + info_data_toggle + "'></span></a></div>";
                        $available_plugins_container.append(html);

                        $('[data-toggle=' + info_data_toggle + ']').popover({
                            trigger : 'hover',
                            placement : 'right',
                            html : false,
                            content : function() {
                                return plugin_specs[$(this).html()]["description"]
                            }
                        });

                    }

                    $('#selected-plugins > div').map(function () {
                        if (!($(this).find('a').html() in plugin_specs)) {
                            $(this).remove();
                            delete plugin_to_user_input[parseInt($(this).find('a').attr('name').split("_")[1])]
                        }
                    });
                    var mop_specs = {{ mop_specs|tojson|safe }};

                    if (first_load_on_edit && mop_specs) {
                        var removed_plugins = [];

                        for (var i = 0; i < mop_specs.length; i++) {
                            if (mop_specs[i]["plugin"] in plugin_specs) {
                                select_plugin(mop_specs[i]["plugin"], mop_specs[i]["data"]);
                            } else {
                                removed_plugins.push(mop_specs[i]["plugin"]);
                            }
                        }

                        if (removed_plugins.length > 0) {
                            var message = "The following plugins previously defined in this MOP are no longer found:<br><ul><li>";
                            message += removed_plugins.join("</li><li>");
                            message += "</li></ul>They will be removed from this MOP after saving.";
                            bootbox.alert(message);
                        }
                    }

                }
            });
        }

        var available_plugins_dragula = dragula([$("#available-plugins")[0], $("#container-separator")[0], $("#selected-plugins")[0]], {
            copy: function (el, source) {
                return source === $("#available-plugins")[0]
            },
            accepts: function (el, target) {
                return target !== $("#available-plugins")[0]
            }
        });

        var selected_plugins_dragula = dragula([$("#selected-plugins")[0]], {
            removeOnSpill: true
        });
        get_available_plugins(true);


        selected_plugins_dragula.on('remove', function (el, target, source, sibling) {
            //console.log($(el).find('a').attr('name'));
            //console.log(target);
            //console.log(source);
            //console.log(sibling);
            delete plugin_to_user_input[parseInt($(el).find('a').attr('name').split("_")[1])];

        });


        available_plugins_dragula.on('drop', function (el, target, source, sibling) {
            // For the selected plugin from the available plugins,
            // update its name so that next time when the same plugin
            // is dragged and dropped, the selected plugin
            // will have a new name as its unique identifier.
            if ($(source).attr("id") == "available-plugins") {
                $(source).find("[name='" + $(el).find('a').attr('name') + "']").attr("name", get_next_plugin_uid());
            }
            $(el).removeAttr('data-toggle');
            $('.popover').remove();
            //console.log(target);
            //console.log(source);
            //console.log(sibling);
        });

        function get_next_plugin_uid() {
            var next_uid = "plugin_" + plugin_uid;
            plugin_uid += 1;
            return next_uid;
        }

        function select_plugin(plugin_name, plugin_data) {
            var name = $("#available-plugins div a:contains(" + plugin_name + ")").attr("name");

            if (Object.keys(plugin_specs[plugin_name]["data_specs"]).length > 0) {
                $("#selected-plugins").append("<div><a name='" + name + "' class='need-data'>" + plugin_name + "</a></div>");
            } else {
                $("#selected-plugins").append("<div><a name='" + name + "' class='no-data'>" + plugin_name + "</a></div>");
            }

            $("#available-plugins").find("[name='" + name + "']").attr("name", get_next_plugin_uid());

            plugin_to_user_input[parseInt(name.split("_")[1])] = {};
            for (var attribute in plugin_data) {
                plugin_to_user_input[parseInt(name.split("_")[1])][attribute] = plugin_data[attribute];
            }
        }

        $('#save-mop').on('click', function () {
            $('#form').submit();
        });

        function submit_form_data(specs) {
            if (original_mop_name) {
                var url = "/mop/" + original_mop_name + "/edit"
            } else {
                var url = "/mop/create"
            }

            $.ajax({
                url: url,
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                type: "POST",
                data: JSON.stringify({
                    name: $('#mop_name').val(),
                    phases: $('#phase').val(),
                    platforms: $('#platform').val(),
                    specs: specs
                }),
                success: function (data) {
                    if (data.redirect_url) {
                        // data.redirect contains the string URL to redirect to
                        window.location.href = data.redirect_url;
                    }

                }
            });
        }


        $('#form').submit(function (e) {
            var mop_name = $('#mop_name').val();

            var acceptable_string = get_acceptable_string(mop_name);

            if (acceptable_string == "") {
                bootbox.alert("Please specify a valid mop name.");
                return false;
            }

            if (acceptable_string != mop_name) {
                var message = get_acceptable_string_message('MOP name', mop_name, acceptable_string);
                bootbox.confirm(message, function (result) {
                    if (result) {
                        $('#mop_name').val(acceptable_string);
                    }
                });
            }

            if (!$('#phase').val()) {
                bootbox.alert("Please specify the phase(s) that this mop can apply to.");
                return false;
            }
            if (!$('#platform').val()) {
                bootbox.alert("Please specify the platform(s) that this mop can apply to.");
                return false;
            }

            var plugins_specs = [];
            $('#selected-plugins > div a').map(function () {
                var specs = {};
                specs["plugin"] = $(this).html();
                specs["data"] = {};
                var user_input_data = plugin_to_user_input[parseInt($(this).attr("name").split("_")[1])];

                if (Object.keys(plugin_specs[specs["plugin"]]["data_specs"]).length > 0) {
                    if (user_input_data === undefined) {
                        bootbox.alert("Please click on selected plugin '" + specs["plugin"] + "' to specify required input.");
                        return false;
                    }
                    for (var attribute in user_input_data) {
                        specs["data"][attribute] = user_input_data[attribute]
                    }
                }
                plugins_specs.push(specs);
            });

            if (plugins_specs.length < 1) {
                bootbox.alert("Please select plugins for this mop.");
                return false;
            }

            submit_form_data(plugins_specs);

            e.preventDefault(e);

        });

        $(document).on('keydown.autocomplete', '.allow-host-variables', function() {
            set_autocomplete_for_host_variables($(this));
        });

    });
</script>
  
{% endblock %}

{% block main %}

<link href="/static/jquery/css/mop.css" rel="stylesheet" />

<link href="/static/dragula-3.7.2/css/dragula.min.css" rel="stylesheet" />
<script src="/static/dragula-3.7.2/js/dragula.min.js" type="text/javascript"></script>

<script src="/static/jquery/js/generate_mop_plugin_detail.js" type="text/javascript"></script>

<div class="row">
    <div class="well col-sm-offset-1 col-sm-10">
        <form id="form" method=post class="form-horizontal">
            <legend>{% if isEdit %}Edit MOP{% else %}Create MOP{% endif %}</legend>
            
            {{ alert_duplicate(form.mop_name.data, duplicate_error) }}
            {{ edit_field(form.mop_name, class="form-control", field_width="col-sm-8", label_field_width="col-sm-2") }}
            {{ edit_field(form.phase, class="form-control", field_width="col-sm-8", label_field_width="col-sm-2") }}
            {{ edit_field(form.platform, class="form-control", field_width="col-sm-8", label_field_width="col-sm-2") }}

            <div class="form-group ">
                <label class="col-sm-2 control-label" id="label_platform" for="platform">Plugins</label>
                <div class="col-sm-8">
                <div class="row">
                    <div class="col-sm-6">
                      <label class="control-label">Available</label>
                    </div>
                    <div class="col-sm-6">
                      <label class="control-label">Selected</label>
                    </div>
                  </div>
                  <div id="plugins" class="row">
                    <div id="available-plugins" class="col-sm-6 dragula-container"></div>
                    <div id="container-separator" class="col-sm-1 container-separator"></div>
                    <div id="selected-plugins" class="col-sm-6 dragula-container"></div>
                  </div>
                </div>

                <div id="plugin-details" class="modal" role="dialog">
                    <div class="modal-dialog" style="width:950px;">
                        <form class="form-horizontal">
                            <div class="modal-content">
                                <div class="modal-header" style="border-bottom: none;">
                                    <button type="button" class="close" data-dismiss="modal">x</button>
                                </div>
                                <div id="plugin-data" class="modal-body" style="overflow:auto;height:auto">



                                </div>
                            </div>
                        </form>
                    </div>
                </div>



                <!--div class="wrapper col-sm-6">
                    <span class="unselected-title">Available Plugins</span>
                  <div id="available-plugins" class="container">
                    <div>When elements are copyable, they can't be sorted in their origin container</div>
                    <div>Copying prevents original elements from being dragged. A copy gets created and <em>that</em> gets dragged instead</div>
                    <div>Whenever that happens, a <code>cloned</code> event is raised</div>
                    <div>Note that the clones get destroyed if they're not dropped into another container</div>
                    <div>You'll be dragging a copy, so when they're dropped into another container you'll see the duplication.</div>
                  </div>
                    <div class="container-separator"></div>
                  <div id="selected-plugins" class="container">
                  </div>
                </div-->
            </div>

            <div class="form-actions">
                <div class="btn col-sm-offset-5">
                    <button id="save-mop" type="submit" class="btn btn-primary">Save</button>
                    <button type="button" onClick="location.href='{{ url_for('mop.home') }}'" class="btn btn-default">Cancel</button>
                    <img id="spinner" src="{{ url_for('static', filename='spinner.gif') }}">
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}
