{% extends 'base_software.html' %}

{% from 'host/common.html' import edit_field %}
{% from 'host/common.html' import alert_duplicate %}

{% if request.endpoint.endswith('edit') %}
    {% set isEdit = True %}
{% else %}
    {% set isEdit = False %}
{% endif %}

{% block head %}

<script>

    $(function() {
        var spinner = $('#spinner');
        spinner.hide();


        $("#phase").select2();
        $("#platform").select2();

        var all_phases = get_all_valid_options_from_selector("phase");
        var all_platforms = get_all_valid_options_from_selector("platform");

        function get_all_valid_options_from_selector(selector_id) {
            var options = $("#"+ selector_id + " option");
            return $.map(options ,function(option) {
                if (option.value != "ALL") {
                    return option.value;
                }
            });
        }

        set_selected_options_when_all_is_selected($('#phase'), all_phases);
        set_selected_options_when_all_is_selected($('#platform'), all_platforms);

        function set_selected_options_when_all_is_selected(selector, all_valid_options) {
            selector.on('change', function (e) {
                var selected = $(this).val();

                if (has_one_of_these(selected, ["ALL"])) {
                    selector.val(all_valid_options).trigger('change');
                }
                get_available_plugins()
            });
        }

        function get_available_plugins() {
            $.ajax({
                url: "/mop/get_available_plugin_list",
                dataType: 'json',
                type: "POST",
                data: {
                    phases: $('#phase').val(),
                    platforms: $('#platform').val()
                },
                success: function(data) {
                    $('#plugins').empty();
                    var $available_plugins = $("<div>", {id: "available-plugins", "class": "col-sm-6 dragula-container"});
                    var $container_separator = $("<div>", {"class": "col-sm-1 dragula-container-separator"});
                    var $selected_plugins = $("<div>", {id: "selected-plugins", "class": "col-sm-6 dragula-container"});
                    for (var i = 0; i < data.plugins.length; i++) {
                        $available_plugins.append("<div>" + data.plugins[i] +"</div>");
                    }
                    var removed_plugins = [];
                    if ($("#hidden_plugins").val()) {
                        var selected_plugins = $("#hidden_plugins").val().split(",");
                        for (var i = 0; i < selected_plugins.length; i++) {
                            if (data.plugins.indexOf(selected_plugins[i]) < 0) {
                                removed_plugins.push(selected_plugins[i])
                            } else {
                                $selected_plugins.append("<div>" + selected_plugins[i] +"</div>");
                            }
                        }
                    }
                    $('#plugins').append($available_plugins);
                    $('#plugins').append($container_separator);
                    $('#plugins').append($selected_plugins);
                    dragula([$available_plugins[0], $container_separator[0], $selected_plugins[0]], {
                      copy: function (el, source) {
                        return source === $available_plugins[0]
                      },
                      accepts: function (el, target) {
                        return target !== $available_plugins[0]
                      }
                    });

                    dragula([$selected_plugins[0]], {
                      removeOnSpill: true
                    });

                    if (removed_plugins.length > 0) {
                        var message = "The following plugins previously defined in this MOP are no longer found:<br><ul><li>";
                        message += removed_plugins.join("</li><li>");
                        message += "</li></ul>They will be removed from this MOP after saving.";
                        bootbox.alert(message);
                    }

                }
            });
        }
        get_available_plugins();


        $('#form').submit(function() {
            var mop_name = $('#mop_name').val();

            var acceptable_string = get_acceptable_string(mop_name);

            if (acceptable_string == "") {
                bootbox.alert("Please specify a valid mop name.");
                return false;
            }

            if (acceptable_string != mop_name) {
                var message = get_acceptable_string_message('MOP name', mop_name, acceptable_string);
                bootbox.confirm(message, function(result) {
                    if (result) {
                        $('#mop_name').val(acceptable_string);
                    }
                });
            }

            if (!$('#phase').val()) {
                bootbox.alert("Please specify the phase(s) that this mop can apply to.");
                return false;
            }
            if (!$('#platform').val()) {
                bootbox.alert("Please specify the platform(s) that this mop can apply to.");
                return false;
            }
            var plugins = [];
            $('#selected-plugins > div').map(function() {
                plugins.push($(this).html());
            });
            if (plugins.length < 1) {
                bootbox.alert("Please select plugins for this mop.");
                return false;
            }
            $('#hidden_plugins').val(plugins.join());
            console.log($('#hidden_plugins').val());

        });

    });
</script>
  
<style>
    .modal-dialog {    
        width: 850px;
    }
    a:link, a:visited {
        text-decoration:none;
    }
    th,
    td {
        white-space: nowrap;
    }
</style>
  
{% endblock %}

{% block main %}

<link href="/static/dragula-3.7.2/css/dragula.min.css" rel="stylesheet" />
<script src="/static/dragula-3.7.2/js/dragula.min.js" type="text/javascript"></script>
<link href="/static/jquery/css/mop.css" rel="stylesheet" />

<div class="row">
    <div class="well col-sm-offset-2 col-sm-8">
        <form id="form" method=post class="form-horizontal">
            <legend>{% if isEdit %}Edit MOP{% else %}Create MOP{% endif %}</legend>
            
            {{ alert_duplicate(form.mop_name.data, duplicate_error) }}
            {{ edit_field(form.mop_name, class="form-control", field_width="col-sm-7", label_field_width="col-sm-3") }}
            {{ edit_field(form.phase, class="form-control", field_width="col-sm-7", label_field_width="col-sm-3") }}
            {{ edit_field(form.platform, class="form-control", field_width="col-sm-7", label_field_width="col-sm-3") }}


            <div class="form-group ">
                <label class="col-sm-3 control-label" id="label_platform" for="platform">Plugins</label>
                 <div class="col-sm-7">
                <div class="row">
                    <div class="col-sm-6">
                      <label class="control-label">Available</label>
                    </div>
                    <div class="col-sm-6">
                      <label class="control-label">Selected</label>
                    </div>
                  </div>
                  <div id="plugins" class="row">
                    <!--div id="available-plugins" class="col-sm-6 container">
                      <div>Install Commit Plugin</div>
                    <div>Node Status Plugin</div>
                    <div>Disk Space Check Plugin</div>
                    <div>Filesystem Check Plugin</div>
                    <div>Configuration Plugin</div>

                    </div>

                    <div class="col-sm-1 container-separator"></div>
                    <div id="selected-plugins" class="col-sm-6 container"></div-->
                  </div>
                </div>
                <input id="hidden_plugins" name="{{ form.hidden_plugins.name }}" value="{{ form.hidden_plugins.data }}" type="hidden">

                <!--div class="wrapper col-sm-6">
                    <span class="unselected-title">Available Plugins</span>
                  <div id="available-plugins" class="container">
                    <div>When elements are copyable, they can't be sorted in their origin container</div>
                    <div>Copying prevents original elements from being dragged. A copy gets created and <em>that</em> gets dragged instead</div>
                    <div>Whenever that happens, a <code>cloned</code> event is raised</div>
                    <div>Note that the clones get destroyed if they're not dropped into another container</div>
                    <div>You'll be dragging a copy, so when they're dropped into another container you'll see the duplication.</div>
                  </div>
                    <div class="container-separator"></div>
                  <div id="selected-plugins" class="container">
                  </div>
                </div-->
            </div>

            <div class="form-actions">
                <div class="btn col-sm-offset-5">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" onClick="location.href='{{ url_for('mop.home') }}'" class="btn btn-default">Cancel</button>
                    <img id="spinner" src="{{ url_for('static', filename='spinner.gif') }}">
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}
